# DB 마이그레이션 가이드

이 문서는 데이터베이스 마이그레이션을 위한 상세 가이드입니다.

## 필수 조건

- Docker가 실행 중이어야 합니다.
- PostgreSQL 컨테이너가 실행 중이어야 합니다.
- Atlas 마이그레이션 도구가 설치되어 있어야 합니다.

## 새로운 마이그레이션 생성하기

새로운 마이그레이션을 생성하려면 다음 명령어를 사용합니다:

```bash
make new-migration name=마이그레이션_이름
```

예시:
```bash
make new-migration name=add_user_table
```

### 동작 과정

1. 임시 데이터베이스(`todo_db_migrations_dev`)를 생성합니다.
2. Ent 스키마를 기반으로 새로운 마이그레이션 파일을 생성합니다.
3. 생성된 마이그레이션을 테스트로 적용해봅니다.
4. 임시 데이터베이스를 정리합니다.

### 주의사항

- 마이그레이션 이름은 영문으로 작성하며, 언더스코어(_)를 사용하여 단어를 구분합니다.
- 마이그레이션 이름은 변경 내용을 명확하게 설명해야 합니다.
  - 좋은 예: `add_user_table`, `update_todo_status_column`
  - 나쁜 예: `update1`, `changes`

## 마이그레이션 파일 위치

생성된 마이그레이션 파일은 `migrations` 디렉토리에 저장됩니다. 각 파일은 다음과 같은 형식으로 생성됩니다:
```
YYYYMMDDHHMMSS_마이그레이션_이름.sql
```

## 마이그레이션 적용하기

실제 데이터베이스에 마이그레이션을 적용하려면 다음 명령어를 사용합니다:

```bash
make migrate
```

이 명령어는 아직 적용되지 않은 모든 마이그레이션을 순서대로 실행합니다.

### 주의사항
- 마이그레이션을 적용하기 전에 데이터베이스 백업을 권장합니다.
- 운영 환경에 적용하기 전에 개발/테스트 환경에서 먼저 테스트하세요.

## 마이그레이션 상태 확인하기

현재 마이그레이션의 적용 상태를 확인하려면 다음 명령어를 사용합니다:

```bash
make migrate-status
```

이 명령어는 다음 정보를 보여줍니다:
- 적용된 마이그레이션 목록
- 각 마이그레이션의 적용 시간
- 아직 적용되지 않은 마이그레이션 목록

### 상태 확인이 필요한 경우
- 마이그레이션 적용 전 현재 상태 확인
- 문제 해결 시 어떤 마이그레이션이 적용되었는지 확인
- 운영 환경과 개발 환경의 마이그레이션 상태 비교

## 문제 해결

### 마이그레이션 생성 실패 시

1. PostgreSQL 컨테이너가 실행 중인지 확인합니다.
2. 데이터베이스 연결 정보가 올바른지 확인합니다.
3. 이전 임시 데이터베이스가 남아있다면 수동으로 삭제합니다:
   ```bash
   docker exec -i todo_postgres dropdb -U postgres todo_db_migrations_dev
   ```

### 도움이 필요하신가요?

문제가 발생하거나 추가 도움이 필요한 경우, 프로젝트 관리자에게 문의해주세요.
